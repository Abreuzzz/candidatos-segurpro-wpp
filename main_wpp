import time
from datetime import datetime
import io
import logging

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from openpyxl.reader.excel import load_workbook

# chromedriver-py
import chromedriver_py

logging.basicConfig(level=logging.INFO)

wb = load_workbook('Pasta3.xlsx')
ws = wb["Planilha78"]

numbers_list = [cell.value for cell in ws['A'] if cell.value != "Telefones"]
successful_numbers = []
failed_numbers = []

# --- inicialização com chromedriver-py ---
service = Service(executable_path=chromedriver_py.binary_path)
browser = webdriver.Chrome(service=service)
wait = WebDriverWait(browser, 60)
# -----------------------------------------

inicio = time.time()

for idx, number in enumerate(numbers_list, start=1):
    try:
        browser.get(f'https://web.whatsapp.com/send/?phone=55{number}&text&type=phone_number&app_absent=0')
        browser.maximize_window()
        wait.until(EC.title_contains('WhatsApp'))
        elem = wait.until(EC.presence_of_element_located((By.XPATH,
            # '/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div[1]/div[2]/div[1]/p')))
            '/html/body/div[1]/div/div[1]/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div/div[3]/div[1]/p')))
        elem.send_keys(
            # "Olá, boa noite! Tudo bem?\nMe chamo Karina e falo do Recrutamento e Seleção do Grupo Segurpro...\n"
            "Olá, boa noite! Tudo bem?\nMe chamo Karina e falo do Recrutamento e Seleção do Grupo Segurpro.\nEstamos com oportunidades para atuar como Vigilante Intermitente em uma operação especial de grande porte em São Paulo nos dias 12, 13 e 14/09.\nVocê possui interesse?\nSe tiver disponibilidade imediata e reciclagem em dia, pedimos que compareça com seus documentos em:\nRUA DOS ITALIANOS, 988 - BOM RETIRO\nAmanhã (11/09) ÀS 8H.\nContamos com sua presença!\n"
            # "Olá, boa noite! Tudo bem?\nMe chamo Karina e falo do Recrutamento e Seleção do Grupo Segurpro.\nTeremos novo processo seletivo para atuar no evento The Town 2025 em São Paulo/SP\nTopa participar desta jornada conosco?\nEntrevista presencial: 10/09 às 8h\nRua Monsenhor Manoel Gomes, 60 B – São Cristóvão\nLevar RG, CPF, PIS, comprovante de residência e certificados.\nData de embarque: 11/09 ás 11hs\nData de retorno: 15/09\nPARA TRABALHAR NOS DIAS 12,13 e 14 DE SETEMBRO.\nPodemos confirmar sua presença?\n"
            # "Por favor desconsiderar as mensagens acima.\nObrigada!\n"
        )
        remaining = len(numbers_list) - idx
        logging.info(f'Sent message to {number} | Restam: {remaining}')
        successful_numbers.append(number)

    except Exception as e:
        logging.error(f'Erro com {number}: {e}')
        failed_numbers.append(number)

    finally:
        time.sleep(5)
        try:
            alert = browser.switch_to.alert
            alert.accept()
            logging.info('Alert accepted')
        except:
            pass

# --- relatório ---
report_number = [11969257920, 11953075442]

end = time.time()
tempo = (end - inicio)
formato_tempo = time.strftime("%H:%M:%S", time.gmtime(tempo))
tempo_medio = tempo / len(numbers_list)
formato_tempo_medio = time.strftime("%H:%M:%S", time.gmtime(tempo_medio))

report_message = (
    f'Total de números: {len(numbers_list)}\n'
    f'Números enviados com sucesso: {len(successful_numbers)}\n'
    f'Números enviados com erro: {len(failed_numbers)}\n'
    f'Números com erro: {failed_numbers}\n'
    f'Tempo de execução: {formato_tempo}\n'
    f'Tempo médio por número: {formato_tempo_medio}\n'
)

for numero in report_number:
    browser.get(f'https://web.whatsapp.com/send/?phone=55{numero}&text&type=phone_number&app_absent=0')
    browser.maximize_window()
    wait.until(EC.title_contains('WhatsApp'))
    elem = wait.until(EC.presence_of_element_located((By.XPATH,
        '/html/body/div[1]/div/div[1]/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div/div[3]/div[1]/p')))
    elem.send_keys(report_message)
    logging.info(f'Sent report to {numero}')
    time.sleep(10)

print(report_message)
browser.quit()
